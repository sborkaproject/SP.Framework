// jquery.waitforimages.js
// Thanks to alexanderdickson
// https://github.com/alexanderdickson/waitForImages

/*!
 * SP Framework
 * VERSION: 1.016
 * DATE: 2015-06-19
 * 
 * @author: Hauts, misha@sborkaproject.com
 */
!function(){var e={deep:{props:["backgroundImage","listStyleImage","borderImage","borderCornerImage","cursor"],attrs:["srcset"]},quick:{props:["backgroundImage"],attrs:["srcset"]}},t=/url\(\s*(['"]?)(.*?)\1\s*\)/g;$.fn.waitForImages=function(n,r,a){for(var i=this[0],l=[],o=this.first().find("*").addBack(),s=o.length,c=a?e.deep:e.quick,u=c.props,d=c.attrs,m=u.length,p=d.length,f=0;s>f;f++){var g=o.eq(f),y=g[0];if("img"==g[0].tagName.toLowerCase()){var h=g.attr("src");h&&""!=h&&l.push({src:h,element:y})}for(var S=0;m>S;S++){var w=u[S],A=g.css(w);if(A)for(var C;C=t.exec(A);)l.push({src:C[2],element:y})}if(a)for(var S=0;p>S;S++){var v=d[S],P=g.attr(v);if(P)for(var I=P.split(","),D=I.length,O=0;D>O;O++)l.push({src:$.trim(P[O]).split(" ")[0],element:y})}}var E=l.length,N=[];if(0==E)n.call(i);else for(var b=0,f=0;E>f;f++){var L=new Image;L.imageData=l[f],L.onload=L.onerror=function(e){b++,r.apply(this.imageData.element,[b,E,"load"==e.type]),b==E&&n.call(i),this.onload=this.onerror=null},L.src=L.imageData.src,N.push(L.imageData.element)}return N}}(),function(){function SP(){}function initialize(name,skipWindowScope){name=typeof name==U?"SiteController":internals.createName(name);var SiteController=internals.createInstance(name,{name:name,states:internals.createInstance("States",{INIT:"init",DOM_READY:"dom-ready",WINDOW_LOADED:"window-loaded",IMAGES_LOADED:"images-loaded"},!0),customs:internals.createInstance("Customs"),utils:internals.createInstance("Utils",{createInstance:function(e,t,n){return internals.createInstance(e,t,n)},capitalizeFirstLetter:function(e){return internals.capitalizeFirstLetter(e)},log:function(){internals.log(internals.argsToArray(arguments),!0)},error:function(){internals.error(internals.argsToArray(arguments),!0)},warn:function(){internals.warn(internals.argsToArray(arguments),!0)},inform:function(){internals.inform(internals.argsToArray(arguments),!0)},shim:function(e,t,n,r){return function(){SiteController.utils.testApply(e,t,n,r)}},delegate:function(e,t){return function(){t.apply(e,internals.argsToArray(arguments))}},onceDelegate:function(e,t,n,r){var a=!1;return function(){a||(a=!0,SiteController.utils.testApply(e,t,n,r))}},testApply:function(e,t,n,r){if("function"==typeof t)if(n=typeof n==U?[]:SiteController.utils.isArray(n)?n:[n],r)try{t.apply(e,n)}catch(a){}else t.apply(e,n)},isArray:function(e){return internals.isArray(e)},now:function(){return internals.now()},hideElementShim:function(e){return function(){$(e).hide()}},removeElementShim:function(e){return function(){$(e).remove()}},getType:function(e){return{}.toString.call(e).match(/\s([a-z|A-Z]+)/)[1].toLowerCase()},cubicProgress:function(e){return e=0>e?0:e>1?1:e,e/=.5,1>e?.5*e*e*e:(e-=2,.5*(e*e*e+2))},argsToArray:function(){return internals.argsToArray(arguments)}}),pages:internals.createInstance("Pages",{runCurrent:function(){return internals.pageStarted?internals.error("Page already started"):(internals.pageStarted=!0,void(internals.startPage&&internals.startPage.init&&SiteController.utils.testApply(internals.startPage,internals.startPage.init,internals.startPageArgs)))},all:[],add:function(e,t,n,r){if(e=internals.createName(e),internals.log("Add page: "+e),typeof this[e]!=U)return internals.error("Page "+e+" already added!"),this[e];var a=internals.createInstance(SiteController.utils.capitalizeFirstLetter(e),{init:function(r){return this.inited?internals.error("Page already inited: "+moduleName):(internals.log("Page init: "+e),this.inited=!0,internals.cloneObjectPropsTo(n,this),SiteController.utils.testApply(this,t,r),this)},name:e});return this[e]=a,SiteController.utils.testApply(a,r),this.all.push(a),a}}),modules:internals.createInstance("Modules",{all:[],add:function(e,t,n,r,a){if(e=internals.createName(e),a="number"==typeof a?a:0,internals.log("Add module: "+e+", init state: "+(typeof r==U?"[no init state]":r)+", init priority: "+a),typeof this[e]!=U)return internals.error("Module "+e+" already added!"),this[e];var i=internals.createInstance(SiteController.utils.capitalizeFirstLetter(e),{init:function(){return this.inited?internals.error("Module already inited: "+e):(internals.log("Module init: "+e),this.inited=!0,internals.cloneObjectPropsTo(n,this),SiteController.utils.testApply(this,t,internals.argsToArray(arguments)),this)},name:e,initPriority:a});return this[e]=i,typeof r!=U&&(modulesByStates=internals.modulesByStates[r],typeof modulesByStates==U&&(internals.modulesByStates[r]=modulesByStates=[]),modulesByStates.push(i)),this.all.push(i),$.inArray(r,internals.passedStates)>-1&&(internals.warn("Module "+e+" initState already passed!"),i.init()),i},initAll:function(){var e=this.all.length;internals.sortByInitPriority(this.all);for(var t=0;e>t;t++){var n=this.all[t];n.inited||n.init()}}}),elements:internals.createInstance("Elements",{all:[],add:function(elementName,constructor,prototypeObject,classModificator){if(elementName=internals.createName(elementName),internals.log("Add element: "+elementName),typeof this[elementName]!=U)return internals.error("Element "+elementName+" already added!"),this[elementName];elementCodeString="(function(){return function "+elementName+"(){internals.log('Creating new element: ' + elementName);SiteController.utils.testApply(this, constructor, Array.prototype.slice.call(arguments));}})()";var newElement=eval(elementCodeString);return internals.cloneObjectPropsTo(prototypeObject,newElement.prototype),newElement.name=newElement.prototype.name=elementName,this[elementName]=newElement,this.all.push(newElement),SiteController.utils.testApply(newElement,classModificator),newElement}}),start:function(e){function t(e){internals.inform("Next state: "+e);var t=internals.modulesByStates[e];if(SiteController.utils.isArray(t)&&t.length){var n=t.length;internals.sortByInitPriority(t);for(var r=0;n>r;r++){var a=t[r];a.inited||a.init()}internals.modulesByStates[e]=[]}internals.passedStates.push(e),SiteController.utils.testApply(SiteController,internals.constructor,[e])}function n(e){if(e==SiteController.states.INIT||e==SiteController.states.IMAGES_LOADED)t(e);else if(e==SiteController.states.DOM_READY){this.$html=$("html"),this.$body=$("body"),t(e);var r=this.$body.waitForImages(function(){internals.imagesLoaded=!0,internals.windowLoaded&&n.apply(SiteController,[SiteController.states.IMAGES_LOADED])},function(e,t,n){SiteController.utils.testApply(SiteController,internals.imageProgressHandler,[e/t,this,n])},!0);SiteController.utils.testApply(SiteController,internals.imageCollectedHandler,[r])}else e==SiteController.states.WINDOW_LOADED&&(t(e),internals.windowLoaded=!0,internals.imagesLoaded&&n.apply(SiteController,[SiteController.states.IMAGES_LOADED]))}return internals.started?internals.error("Site already started!"):(internals.started=!0,"string"==typeof e&&(e=this.pages[e]),internals.startPage=e,internals.startPageArgs=[Array.prototype.slice.call(arguments,1)],this.$window=$(window),this.$document=$(document),$(SiteController.utils.shim(this,n,[SiteController.states.DOM_READY])),this.$window.load(SiteController.utils.shim(this,n,[SiteController.states.WINDOW_LOADED])),void n.apply(this,[SiteController.states.INIT]))},construct:function(e,t,n,r){return internals.constructed?internals.error("Site already constructed!"):(internals.constructed=!0,internals.constructor=e,internals.imageCollectedHandler=n,internals.imageProgressHandler=r,void internals.cloneObjectPropsTo(t,this))}});return skipWindowScope||(window[name]=SiteController),SiteController}var U="undefined",O="object",internals={VERSION:"1.016 [19.06.2015]",previousSP:window.SP,created:!1,debugMode:!1,started:!1,startPage:null,startPageArgs:null,imageCollectedHandler:null,imageProgressHandler:null,imagesLoaded:!1,windowLoaded:!1,modulesByStates:{},passedStates:[],pageStarted:!1,constructed:!1,sayHello:function(){var e=["☭","★","✪","✫","✌","♚","♛","✍","☢"],t=e[Math.floor(Math.random()*e.length)],n=function(e,t){return"font-size:"+e+"px;color:"+t+";"};window.console.log("%c"+t,n(48,"#DC143C")),window.console.log("%cSborka Project",n(39,"#DC143C")),window.console.log("%cSP Framework v"+internals.VERSION+"\n\n",n(17,"#11161F"))},log:function(e,t,n){try{if(internals.debugMode||n){for(var r=internals.isArray(e)?e:[e],a=r.length,i=internals.now().toFixed(2),l=i.length,o=" ➙ ",s="";l;)s=" "+s,l--;var c="font-size: 11px; color: "+("undefined"==typeof t?"#666666":t)+"; font-style: italic;";window.console.log("🕒 %c"+i+o+r[0],c);for(var u=1;a>u;u++)window.console.log("%c   "+s+o+r[u],c)}}catch(d){internals.debugMode=!1}},error:function(e,t){internals.log(e,"#ff0000",t)},inform:function(e,t){internals.log(e,"#579e6a",t)},warn:function(e,t){internals.log(e,"#ff7700",t)},cloneObjectPropsTo:function(e,t){if(typeof t!=O&&(t={}),typeof e!=O)return t;for(var n in e)t[n]=e[n];return t},createInstance:function(name,props,lock){var result=internals.cloneObjectPropsTo(props,eval("new (function "+name+"(){})()"));return lock&&Object.seal&&Object.seal(result),result},capitalizeFirstLetter:function(e){return e.charAt(0).toUpperCase()+e.slice(1)},createName:function(e){return internals.capitalizeFirstLetter($.trim(e))},cached:function(){var e=initialize("SiteController",!0);return internals.cached=function(){return e},internals.cached()},sortByInitPriority:function(e){e.sort(function(e,t){return t.initPriority-e.initPriority})},isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)},now:function(){return internals.now=window.performance&&window.performance.now?function(){return window.performance.now()}:function(){return+new Date},internals.now()},argsToArray:function(e){return Array.prototype.slice.call(e)}};SP.prototype.current=internals.cached(),SP.prototype.create=function(e,t,n){function r(e,t){var n=e.all.length;for(var r in e)for(var a=e[r],i=0;n>i;i++){var l=e.all[i];l===a&&(t[r]=l,t.all.push(l))}}if(internals.created)return internals.error("SP instance '"+this.current.name+"' is already created!");internals.created=!0,internals.debugMode=t?!0:!1;var a=this.current;return this.current=initialize(e,n),r(a.elements,this.current.elements),r(a.pages,this.current.pages),r(a.modules,this.current.modules),t&&internals.sayHello(),this.current};var SPInstance=new SP;SP.prototype.noConflict=function(){return window.SP=internals.previousSP,SPInstance},SPInstance.VERSION=internals.VERSION,window.SP=SPInstance}();